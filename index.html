<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <title>CHINACNU 员工报销系统</title>
  <style>
    body { font-family: Arial; padding: 30px; background: #f4f4f4; }
    h2 { color: #333; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    input { padding: 5px; margin-right: 10px; }
    button { padding: 6px 12px; }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDjjG4fnHmLQrLJCz6ETi2g513Lww8PlEs",
      authDomain: "baoxiao-a2630.firebaseapp.com",
      projectId: "baoxiao-a2630",
      storageBucket: "baoxiao-a2630.appspot.com",
      messagingSenderId: "641621196318",
      appId: "1:641621196318:web:92887c18e578cd9f7c380f"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const expensesRef = collection(db, "expenses");
    let total = 0;

    function createRow(id, name, date, item, amount) {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${name}</td>
        <td>${date}</td>
        <td>${item}</td>
        <td>¥${amount.toFixed(2)}</td>
        <td>
          <button onclick="editExpense('${id}', this)">编辑</button>
          <button onclick="deleteExpense('${id}', this, ${amount})">删除</button>
        </td>
      `;
      document.getElementById("expenseTable").appendChild(row);
    }

    async function loadExpenses() {
      const querySnapshot = await getDocs(expensesRef);
      querySnapshot.forEach(docSnap => {
        const data = docSnap.data();
        createRow(docSnap.id, data.name, data.date, data.item, data.amount);
        total += data.amount;
      });
      document.getElementById("total").innerText = `¥${total.toFixed(2)}`;
    }

    window.addExpense = async function () {
      const name = document.getElementById("name").value;
      const date = document.getElementById("date").value;
      const item = document.getElementById("item").value;
      const amount = parseFloat(document.getElementById("amount").value);

      if (!name || !date || !item || isNaN(amount)) {
        alert("请填写所有字段！");
        return;
      }

      try {
        const docRef = await addDoc(expensesRef, { name, date, item, amount, timestamp: new Date() });
        createRow(docRef.id, name, date, item, amount);
        total += amount;
        document.getElementById("total").innerText = `¥${total.toFixed(2)}`;
        document.getElementById("item").value = "";
        document.getElementById("amount").value = "";
      } catch (e) {
        console.error("保存失败：", e);
        alert("数据保存失败，请检查网络或权限设置。");
      }
    }

    window.editExpense = async function (id, btn) {
      const row = btn.closest("tr");
      const tds = row.querySelectorAll("td");
      const newItem = prompt("修改内容：", tds[2].innerText);
      const newAmount = parseFloat(prompt("修改金额：", tds[3].innerText.replace("¥", "")));
      if (newItem && !isNaN(newAmount)) {
        await updateDoc(doc(db, "expenses", id), { item: newItem, amount: newAmount });
        total -= parseFloat(tds[3].innerText.replace("¥", ""));
        total += newAmount;
        tds[2].innerText = newItem;
        tds[3].innerText = `¥${newAmount.toFixed(2)}`;
        document.getElementById("total").innerText = `¥${total.toFixed(2)}`;
      }
    }

    window.deleteExpense = async function (id, btn, amount) {
      if (confirm("确定要删除这条记录吗？")) {
        await deleteDoc(doc(db, "expenses", id));
        const row = btn.closest("tr");
        row.remove();
        total -= amount;
        document.getElementById("total").innerText = `¥${total.toFixed(2)}`;
      }
    }

    window.onload = loadExpenses;
  </script>
</head>
<body>
  <h2>CHINACNU 员工报销系统</h2>

  <div>
    <label>姓名：</label><input type="text" id="name" />
    <label>日期：</label><input type="date" id="date" />
    <label>内容：</label><input type="text" id="item" />
    <label>金额：</label><input type="number" id="amount" />
    <button onclick="addExpense()">添加</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>姓名</th>
        <th>日期</th>
        <th>内容</th>
        <th>金额 (元)</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody id="expenseTable">
    </tbody>
    <tfoot>
      <tr>
        <td colspan="4"><strong>总计：</strong></td>
        <td id="total">¥0.00</td>
      </tr>
    </tfoot>
  </table>
</body>
</html>
